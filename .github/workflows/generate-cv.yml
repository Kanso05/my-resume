name: Generate CV

on:
  push:
    branches: [main]

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install anthropic
      run: pip install anthropic
    
    - name: Generate CVs
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python << 'EOF'
        import anthropic, os, glob, hashlib
        from pathlib import Path
        
        # CrÃ©er rÃ©pertoire Output
        os.makedirs('Output', exist_ok=True)
        
        # Lire template
        with open('Template/Cv_modern.html', 'r', encoding='utf-8') as f:
            template = f.read()
        
        client = anthropic.Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))
        files_changed = []
        
        # Traiter tous les CV
        for cv_file in glob.glob('CV/*.md'):
            with open(cv_file, 'r', encoding='utf-8') as f:
                cv_content = f.read()
            
            # GÃ©nÃ©rer avec Claude
            response = client.messages.create(
                model="claude-sonnet-4-20250514",
                max_tokens=4000,
                messages=[{
                    "role": "user",
                    "content": f"""IntÃ¨gre ce CV markdown dans le template HTML. RÃ©ponds uniquement avec le HTML final complet.

        CV Markdown:
        {cv_content}

        Template HTML:
        {template}"""
                }]
            )
            
            html = response.content[0].text.strip()
            if html.startswith('```'):
                html = html.split('```')[1].split('```')[0].strip()
                if html.startswith('html'):
                    html = html[4:].strip()
            
            # Sauvegarder si diffÃ©rent
            output_file = f"Output/{Path(cv_file).stem}.html"
            
            needs_update = True
            if os.path.exists(output_file):
                with open(output_file, 'r', encoding='utf-8') as f:
                    old_content = f.read()
                if hashlib.md5(old_content.encode()).hexdigest() == hashlib.md5(html.encode()).hexdigest():
                    needs_update = False
            
            if needs_update:
                with open(output_file, 'w', encoding='utf-8') as f:
                    f.write(html)
                files_changed.append(output_file)
                print(f"âœ… GÃ©nÃ©rÃ©: {output_file}")
        
        # Sauvegarder liste des fichiers changÃ©s
        if files_changed:
            with open('/tmp/changed.txt', 'w') as f:
                f.write('\n'.join(files_changed))
        EOF
    
    - name: Commit changes
      run: |
        if [ -f "/tmp/changed.txt" ]; then
          git config --local user.email "action@github.com"
          git config --local user.name "CV Bot"
          git add Output/*.html
          git commit -m "ðŸ¤– CV mis Ã  jour - $(date '+%Y-%m-%d %H:%M')" || exit 0
          git push
        fi
