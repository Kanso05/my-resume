name: Generate CV Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install anthropic
      run: pip install anthropic
    
    - name: Generate CVs
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python << 'EOF'
        import anthropic, os, glob, hashlib
        from pathlib import Path
        
        # CrÃ©er rÃ©pertoire Output
        os.makedirs('Output', exist_ok=True)
        
        # Lire template
        with open('Template/Cv_modern.html', 'r', encoding='utf-8') as f:
            template = f.read()
        
        client = anthropic.Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))
        files_generated = []
        
        # Traiter tous les CV
        for cv_file in glob.glob('CV/*.md'):
            with open(cv_file, 'r', encoding='utf-8') as f:
                cv_content = f.read()
            
            # GÃ©nÃ©rer avec Claude
            response = client.messages.create(
                model="claude-sonnet-4-20250514",
                max_tokens=4000,
                messages=[{
                    "role": "user",
                    "content": f" Tu es un expert en gÃ©nÃ©ration de CV professionnel. Je vais te donner un CV en markdown et un template HTML moderne.
                
                **CV en Markdown ({cv_filename}) :**
                ```markdown
                {cv_content}
                ```
                
                **Template HTML moderne :**
                ```html
                {template_content}
                ```
                
                **Instructions spÃ©cifiques :**
                1. IntÃ¨gre parfaitement le contenu markdown dans le template HTML
                2. Convertis le markdown en HTML sÃ©mantique (h1, h2, p, ul, li, strong, em, etc.)
                3. Respecte absolument la structure, les classes CSS et les styles du template
                4. Assure-toi que les sections du CV s'adaptent aux zones prÃ©vues dans le template
                5. Maintiens l'aspect moderne et professionnel du template
                6. GÃ©nÃ¨re un HTML valide et bien indentÃ©
                7. PrÃ©serve tous les styles CSS et la mise en page du template
                
                **TrÃ¨s important :** RÃ©ponds uniquement avec le code HTML final complet, sans explications, sans balises de code markdown, juste le HTML pur.
                """"
                }]
            )
            
            html = response.content[0].text.strip()
            if html.startswith('```'):
                html = html.split('```')[1].split('```')[0].strip()
                if html.startswith('html'):
                    html = html[4:].strip()
            
            # Sauvegarder
            output_file = f"Output/{Path(cv_file).stem}.html"
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(html)
            files_generated.append(output_file)
            print(f"âœ… GÃ©nÃ©rÃ©: {output_file}")
        
        # Sauvegarder liste des fichiers pour la release
        with open('/tmp/release_files.txt', 'w') as f:
            f.write('\n'.join(files_generated))
        EOF
    
    - name: Create Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: cv-${{ github.run_number }}-${{ github.sha }}
        name: "CV Release - ${{ github.event.head_commit.message }}"
        body: |
          ðŸ¤– CV automatiquement gÃ©nÃ©rÃ©s
          
          **Commit:** ${{ github.sha }}
          **Message:** ${{ github.event.head_commit.message }}
          **Date:** ${{ github.event.head_commit.timestamp }}
          
          Fichiers gÃ©nÃ©rÃ©s:
          $(cat /tmp/release_files.txt | sed 's/Output\//- /' | sed 's/\.html/ (HTML)/')
        files: Output/*.html
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
